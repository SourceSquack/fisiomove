<!-- Bulma-based template (no Angular bindings) -->
<section
  class="section appointment-new"
  aria-labelledby="appointment-new-title"
>
  <div class="container">
    <div class="box">
      <header class="mb-4">
        <h2 id="appointment-new-title" class="title is-4">Crear nueva cita</h2>
        <p class="subtitle is-6">
          Seleccione paciente, fecha y una franja horaria disponible
        </p>
      </header>

      <form
        [formGroup]="appointmentForm"
        class="appointment-new__form"
        novalidate
        (ngSubmit)="onSubmit()"
      >
        <div class="columns is-multiline">
          <div class="column is-6">
            <div class="field">
              <label class="label" for="patient-select">Paciente</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="patient-select" formControlName="patient_id">
                    <option value="" disabled>Selecciona un paciente</option>
                    <option *ngFor="let p of patients" [value]="p.id">
                      {{ p.full_name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-3">
            <div class="field">
              <label class="label" for="date-input">Fecha</label>
              <div class="control">
                <input
                  id="date-input"
                  class="input"
                  type="date"
                  formControlName="appointment_date"
                  [min]="getMinDate()"
                  (change)="onPatientOrDateChange()"
                />
              </div>
            </div>
          </div>

          <div class="column is-3">
            <div class="field">
              <label class="label" for="duration-minutes-select"
                >Duración (min)</label
              >
              <div class="control">
                <div class="select is-fullwidth">
                  <select
                    id="duration-minutes-select"
                    formControlName="duration_minutes"
                  >
                    <option *ngFor="let d of durationOptions" [value]="d">
                      {{ d }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12">
            <div class="field">
              <label class="label" for="appointment-type-select"
                >Tipo de cita</label
              >
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="appointment-type-select" formControlName="type">
                    <option value="" disabled>Selecciona tipo</option>
                    <option
                      *ngFor="let t of appointmentTypes"
                      [value]="t.value"
                    >
                      {{ t.label }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr />

        <div class="block">
          <h3 class="title is-6">Franjas horarias</h3>
          <p class="help">
            Haz clic en una franja para seleccionarla. Las franjas ocupadas
            aparecen deshabilitadas.
          </p>

          <div class="columns is-multiline mt-3 appointment-new__slots">
            <ng-container *ngIf="availableSlots?.length; else noSlots">
              <div class="column is-2" *ngFor="let s of availableSlots">
                <button
                  type="button"
                  class="button is-fullwidth appointment-new__slot"
                  [class.is-disabled]="!s.available"
                  [class.is-selected]="selectedSlot === s.time"
                  [disabled]="!s.available"
                  [attr.aria-pressed]="selectedSlot === s.time"
                  (click)="toggleSelectSlot(s.time, s.available)"
                >
                  <div class="content appointment-new__slot-content">
                    <span class="appointment-new__slot-time"
                      ><strong>{{ s.time }}</strong></span
                    >
                    <span
                      class="appointment-new__slot-status is-size-7"
                      [ngClass]="{
                        'has-text-grey': s.available,
                        'has-text-danger': !s.available
                      }"
                    >
                      {{ s.available ? "Disponible" : "No disponible" }}
                    </span>
                  </div>
                </button>
              </div>
            </ng-container>
            <ng-template #noSlots>
              <div class="column is-12">
                <p class="has-text-grey">
                  No hay franjas disponibles para la fecha/paciente
                  seleccionados.
                </p>
              </div>
            </ng-template>
          </div>
        </div>

        <div class="field">
          <label class="label" for="notes-input">Notas</label>
          <div class="control">
            <textarea
              id="notes-input"
              class="textarea"
              rows="4"
              placeholder="Información relevante para la cita"
              data-bind="notes"
            ></textarea>
          </div>
        </div>

        <div class="field is-grouped is-grouped-right">
          <p class="control">
            <button type="button" class="button" data-action="cancel">
              Cancelar
            </button>
          </p>
          <p class="control">
            <button
              type="submit"
              class="button is-primary"
              [disabled]="!appointmentForm.valid || !selectedSlot"
              data-action="save"
            >
              Guardar cita
            </button>
          </p>
          <div class="control is-hidden-mobile" style="align-self:center;margin-left:12px;">
            @if(getMissingFields().length) {<p class="has-text-danger is-size-7">
              Completa: {{ getMissingFields().join(', ') }}
            </p>}
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
