<div class="header-container">
  <div class="header-title">
    <p>Administra las citas de fisioterapia</p>
  </div>
  <button class="button is-link" (click)="createNewAppointment()">
    <span class="icon is-small">
      <i class="fas fa-plus"></i>
    </span>
    <span> Nueva cita </span>
  </button>
</div>

<!-- Filtros -->
<div class="filters-section">
  <form [formGroup]="filterForm" class="filters-form">
    <div class="filter-group">
      <label for="status">Estado:</label>
      <select
        id="status"
        formControlName="status"
        (change)="onFilterChange()"
        class="form-select"
      >
        @for (status of appointmentStatuses; track status.value) {
        <option [value]="status.value">
          {{ status.label }}
        </option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="date_from">Desde:</label>
      <input
        type="date"
        id="date_from"
        formControlName="date_from"
        (change)="onFilterChange()"
        class="form-input"
      />
    </div>

    <div class="filter-group">
      <label for="date_to">Hasta:</label>
      <input
        type="date"
        id="date_to"
        formControlName="date_to"
        (change)="onFilterChange()"
        class="form-input"
      />
    </div>

    <div class="filter-group">
      <label for="patient_search">Buscar paciente:</label>
      <input
        type="text"
        id="patient_search"
        formControlName="patient_search"
        placeholder="Nombre del paciente..."
        class="form-input"
      />
    </div>
  </form>
</div>

<!-- Error Message -->
@if (errorMessage) {
<i class="fas fa-exclamation-triangle"></i>
{{ errorMessage }}
<button class="btn-close" (click)="clearError()">
  <i class="fas fa-times"></i>
</button>
}

<!-- Loading State -->
@if (isLoading) {
<div class="spinner"></div>
<p>Cargando citas</p>
}

<!-- Lista de Citas -->
@if (!isLoading) {
<div class="appointments-header">
  <span>Paciente</span>
  <span>Fecha</span>
  <span>Hora</span>
  <span>Tipo</span>
  <span>Estado</span>
  <span>Acciones</span>
</div>

@if (appointments.length === 0) {
<i class="fas fa-calendar-times"></i>
<h3>No hay citas</h3>
<p>No se encontraron citas con los filtros aplicados.</p>
<button class="button is-link" (click)="createNewAppointment()">
  Crear Primera Cita
</button>
} @for (appointment of appointments; track appointment.id) {
<div
  class="appointment-card"
  (click)="viewAppointment(appointment.id!)"
  (keydown)="viewAppointment(appointment.id!)"
>
  <div class="appointment-patient">
    <div class="patient-info">
      <h4>{{ getPatientFullName(appointment) }}</h4>
      @if (appointment.patient && appointment.patient.email) {
      <span class="patient-id">{{ appointment.patient.email }}</span>
      }
    </div>
  </div>

  <div class="appointment-date">
    {{ formatDate(appointment.start_time) }}
  </div>

  <div class="appointment-time">
    {{ formatTime(appointment.start_time) }}
  </div>

  <div class="appointment-type">
    <span class="type-badge">{{
      getAppointmentTypeLabel(appointment.appointment_type)
    }}</span>
  </div>

  <div class="appointment-status">
    <span
      class="status-badge"
      [style.background-color]="getStatusColor(appointment.status)"
    >
      {{ getStatusLabel(appointment.status) }}
    </span>
  </div>

  <div class="appointment-actions">
    <button
      class="button is-small is-light"
      (click)="$event.stopPropagation(); viewAppointment(appointment.id!)"
      title="Ver detalles"
    >
      <span class="icon is-small">
        <i class="fas fa-eye"></i>
      </span>
    </button>
    <button
      class="button is-small is-light"
      (click)="$event.stopPropagation(); editAppointment(appointment.id!)"
      title="Editar"
    >
      <span class="icon is-small">
        <i class="fas fa-edit"></i>
      </span>
    </button>
    <button
      class="button is-small is-light"
      (click)="$event.stopPropagation(); cancelAppointment(appointment.id!)"
      title="Cancelar"
    >
      <span class="icon is-small">
        <i class="fas fa-times"></i>
      </span>
    </button>
  </div>
</div>
} }

<!-- Paginación -->
@if (!isLoading && totalPages > 1) {
<button
  class="btn-pagination"
  [disabled]="currentPage === 1"
  (click)="onPageChange(currentPage - 1)"
>
  <i class="fas fa-chevron-left"></i>
  Anterior
</button>

<span class="page-info">
  Página {{ currentPage }} de {{ totalPages }} ({{ totalItems }} citas)
</span>

<button
  class="btn-pagination"
  [disabled]="currentPage === totalPages"
  (click)="onPageChange(currentPage + 1)"
>
  Siguiente
  <i class="fas fa-chevron-right"></i>
</button>
}

<!-- Modal de Confirmación -->
@if (showModal) {
<div class="modal-overlay" (click)="closeModal()" (keydown)="closeModal()">
  <div
    class="modal-content"
    (click)="$event.stopPropagation()"
    (keydown)="$event.stopPropagation()"
  >
    <div class="modal-header">
      <h3>Gestionar Cita</h3>
      <button class="btn-close-modal" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      @if (selectedAppointment) {
      <div class="appointment-details">
        <h4>Detalles de la Cita</h4>
        <p>
          <strong>Paciente:</strong>
          {{ selectedAppointment.patient?.full_name || "Paciente" }}
        </p>
        <p>
          <strong>Fecha:</strong>
          {{ formatDate(selectedAppointment.start_time) }}
        </p>
        <p>
          <strong>Hora:</strong>
          {{ formatTime(selectedAppointment.start_time) }}
        </p>
        <p>
          <strong>Tipo:</strong>
          {{ getAppointmentTypeLabel(selectedAppointment.appointment_type) }}
        </p>
        <p>
          <strong>Estado:</strong>
          {{ getStatusLabel(selectedAppointment.status) }}
        </p>
      </div>
      }

      <div class="modal-question">
        <p>¿Qué acción deseas realizar con esta cita?</p>
        <div class="action-buttons">
          <button class="btn-cancel" (click)="confirmCancelAppointment()">
            <i class="fas fa-pause-circle"></i>
            Cancelar Cita
            <small>El paciente canceló o no puede asistir</small>
          </button>

          <button class="btn-delete" (click)="confirmDeleteAppointment()">
            <i class="fas fa-trash"></i>
            Eliminar Cita
            <small>Se digitó incorrectamente</small>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="button is-link is-light" (click)="closeModal()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}
