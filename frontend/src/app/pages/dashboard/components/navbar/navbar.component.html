<nav class="navbar">
  <button class="mobile-menu-btn" (click)="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>

  <div class="search-bar">
    <i class="fas fa-search"></i>
    <input
      type="text"
      placeholder="Buscar pacientes..."
      [(ngModel)]="searchQuery"
      (input)="onSearchInput()"
      autocomplete="off"
    />

    <!-- Modal de resultados -->
    <app-patient-search-modal
      *ngIf="showSearchDropdown && searchQuery"
      [loading]="searchLoading"
      [error]="searchError"
      [results]="searchResults"
      (close)="showSearchDropdown = false"
      (selectPatient)="goToPatientProfile($event)"
    ></app-patient-search-modal>
  </div>

  <div class="user-menu">
    <div class="notifications">
      <i class="fas fa-bell"></i>
      <span class="notification-badge">4</span>
    </div>

    <div class="user-profile-container">
      <div
        class="user-profile"
        (click)="toggleDropdown()"
        (keydown)="toggleDropdown()"
        [class.active]="isDropdownOpen"
      >
        @if (isLoading) {
        <div class="loading-avatar">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        } @else {
        <div class="avatar-icon">
          @if (currentUser?.avatar) {
          <img
            [src]="currentUser?.avatar"
            [alt]="getUserDisplayName()"
            class="avatar-image"
          />
          } @else {
          <span class="avatar-initials">{{ getUserInitials() }}</span>
          }
        </div>
        }

        <span class="user-name">
          @if (isLoading) {
          <span class="loading-text">Cargando...</span>
          } @else {
          {{ getUserDisplayName() }}
          }
        </span>

        <i class="fas fa-chevron-down" [class.rotated]="isDropdownOpen"></i>
      </div>

      <!-- Dropdown Menu -->
      @if (isDropdownOpen) {
      <div
        class="dropdown-menu"
        (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()"
      >
        <div class="dropdown-header">
          <div class="user-info">
            <div class="avatar-icon-large">
              @if (currentUser?.avatar) {
              <img
                [src]="currentUser?.avatar"
                [alt]="getUserDisplayName()"
                class="avatar-image"
              />
              } @else {
              <span class="avatar-initials">{{ getUserInitials() }}</span>
              }
            </div>
            <div class="user-details">
              <div class="user-name-large">{{ getUserDisplayName() }}</div>
              <div class="user-email">{{ currentUser?.email }}</div>
              <div class="user-role">{{ currentUser?.role || "paciente" }}</div>
            </div>
          </div>
        </div>

        <div class="dropdown-divider"></div>

        <div class="dropdown-items">
          <button class="dropdown-item" (click)="goToProfile()">
            <i class="fas fa-user"></i>
            <span>Mi perfil</span>
          </button>

          <button class="dropdown-item" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar sesi√≥n</span>
          </button>
        </div>
      </div>
      }
    </div>
  </div>
</nav>

@if (isDropdownOpen) {
<div
  class="dropdown-overlay"
  (click)="closeDropdown()"
  (keydown)="closeDropdown()"
></div>
}
